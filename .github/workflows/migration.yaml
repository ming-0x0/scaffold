name: DB Migration

on:
  workflow_dispatch:
    inputs:
      migrate:
        description: "Migration mode"
        required: true
        type: choice
        default: "up"
        options:
          - up
          - down
          - down-to
      down_to:
        description: "Version to rollback (only for down-to)"
        required: false
        default: "0"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/scaffold-migration
          tags: |
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=Scaffold Migration
            org.opencontainers.image.description=Database migration for Scaffold
            org.opencontainers.image.version=${{ github.run_number }}
            org.opencontainers.image.created={{date 'YYYY-MM-DD HH:mm:ss'}}
            org.opencontainers.image.revision=${{ github.sha }}
            maintainer=${{ github.repository_owner }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./build/docker/migration.Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/scaffold-migration:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/scaffold-migration:buildcache,mode=max

  migrate:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "latest"

      - name: Load kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig
          kubectl cluster-info
          kubectl get nodes

      - name: Helm upgrade migration
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          helm upgrade --install migration ./deployments/helm/migration \
            --namespace scaffold \
            --set migration.image.repository=${{ secrets.DOCKERHUB_USERNAME }}/scaffold-migration \
            --set migration.dir=/migrations \
            --set database.host=${{ secrets.POSTGRES_HOST }} \
            --set database.port=${{ secrets.POSTGRES_PORT }} \
            --set database.user=${{ secrets.POSTGRES_USER }} \
            --set database.password=${{ secrets.POSTGRES_PASSWORD }} \
            --set database.name=${{ secrets.POSTGRES_DB }} \
            --set database.url=${{ secrets.POSTGRES_URL }} \
            --set database.admin.user=${{ secrets.POSTGRES_ADMIN_USER }} \
            --set database.admin.password=${{ secrets.POSTGRES_ADMIN_PASSWORD }} \
            --set migration.direction=${{ github.event.inputs.migrate }} \
            --set migration.downTo=${{ github.event.inputs.down_to }}

      - name: Show migration job logs
        if: always()
        env:
          KUBECONFIG: ./kubeconfig
        run: |
          POD=$(kubectl get pods -n scaffold \
            -l app=migration \
            --sort-by=.metadata.creationTimestamp \
            -o jsonpath="{.items[-1].metadata.name}")

          if [ -z "$POD" ]; then
            echo "No migration pod found"
            exit 1
          fi

          echo "Migration Pod: $POD"
          echo "------ LOGS ------"

          kubectl logs -n scaffold "$POD" --tail=200 || true
